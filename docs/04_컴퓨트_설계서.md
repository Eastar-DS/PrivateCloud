# 컴퓨트 설계서

## 에이블스택(HCI) 기반 멀티테넌트 프라이빗 클라우드 인프라 설계

| 항목 | 내용 |
|------|------|
| 문서명 | 컴퓨트 설계서 |
| 버전 | 1.0 |
| 작성일 | 2026-01-30 |
| 담당팀 | 컴퓨트/개발 팀 |

---

**목차**

1. [설계 개요 및 목표](#1-설계-개요-및-목표)
2. [리소스 풀 설계](#2-리소스-풀-설계)
3. [VM 배치 전략](#3-vm-배치-전략)
4. [리소스 쿼터](#4-리소스-쿼터)
5. [고가용성(HA) 설계](#5-고가용성ha-설계)
6. [VM 템플릿 및 표준화](#6-vm-템플릿-및-표준화)
7. [검증 워크로드 배포 계획](#7-검증-워크로드-배포-계획)

---

## 1. 설계 개요 및 목표

### 1.1 설계 목표

| 목표 | 설명 | 검증 방법 |
|------|------|----------|
| **테넌트 격리** | 테넌트별 컴퓨트 리소스 격리 | 쿼터 적용 확인 |
| **고가용성** | VM 장애 시 자동 복구 | Failover 테스트 |
| **자원 효율성** | 리소스 풀링으로 효율적 활용 | 활용률 모니터링 |
| **표준화** | VM 템플릿으로 일관된 환경 | 템플릿 기반 배포 |

### 1.2 설계 범위

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        컴퓨트 설계 범위                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   In-Scope (담당 영역)                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  - 리소스 풀 구성 및 관리                                            │  │
│   │  - VM 배치 전략 (Affinity/Anti-Affinity)                            │  │
│   │  - 장애 도메인 설계                                                  │  │
│   │  - 리소스 쿼터 정책                                                  │  │
│   │  - HA 설정 (VM 자동 재시작, Live Migration)                         │  │
│   │  - VM 템플릿 관리                                                    │  │
│   │  - 검증 워크로드 배포                                                │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   협업 영역 (다른 팀과 공동)                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  - VM 네트워크 연결 (네트워크 팀)                                    │  │
│   │  - VM 스토리지 볼륨 (스토리지 팀)                                    │  │
│   │  - 모니터링 에이전트 (공통)                                          │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 리소스 풀 설계

### 2.1 풀 구성 전략

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        리소스 풀 구조                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         ┌─────────────────┐                                │
│                         │   Root Pool     │                                │
│                         │  (전체 클러스터) │                                │
│                         └────────┬────────┘                                │
│                                  │                                          │
│        ┌─────────────────────────┼─────────────────────────┐               │
│        │                         │                         │               │
│        ▼                         ▼                         ▼               │
│   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐         │
│   │ 테넌트 풀   │         │ 테넌트 풀   │         │ 관리 풀     │         │
│   │ (A, B, C)   │         │ (공용 서비스)│         │ (운영)      │         │
│   └─────────────┘         └─────────────┘         └─────────────┘         │
│                                                                             │
│   테넌트 풀: 각 테넌트 VM 실행                                              │
│   공용 서비스 풀: DB, 모니터링 등 공용 서비스                               │
│   관리 풀: 플랫폼 관리 VM                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 오버커밋 정책

| 리소스 | 오버커밋 비율 | 설명 |
|--------|-------------|------|
| **CPU** | 2:1 | 물리 1코어당 가상 2코어 할당 가능 |
| **Memory** | 1:1 | 메모리는 오버커밋 없음 (안정성) |
| **Storage** | Thin Provisioning | 실제 사용량만 할당 |

**오버커밋 설정 근거:**
- CPU는 일반적으로 100% 사용되지 않으므로 2:1 오버커밋 적용
- Memory는 스왑 발생 시 성능 저하가 심하므로 오버커밋 없음
- 스토리지는 Thin Provisioning으로 효율적 활용

### 2.3 클러스터 구성

| 구성 요소 | 수량 | 설명 |
|----------|------|------|
| **Zone** | 1개 | 단일 데이터센터 |
| **Pod** | 1개 | 네트워크 도메인 |
| **Cluster** | 1개 | 호스트 그룹 |
| **Host** | 가용 호스트 | HCI 노드 |

---

## 3. VM 배치 전략

### 3.1 Affinity / Anti-Affinity

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Affinity / Anti-Affinity 규칙                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Anti-Affinity (분산 배치) - HA 목적                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │   Host 1              Host 2              Host 3                    │  │
│   │   ┌─────────┐        ┌─────────┐        ┌─────────┐                │  │
│   │   │ Web-A1  │        │ Web-A2  │        │         │                │  │
│   │   │ (테넌트A)│        │ (테넌트A)│        │         │                │  │
│   │   └─────────┘        └─────────┘        └─────────┘                │  │
│   │                                                                     │  │
│   │   ✓ 동일 서비스 VM은 다른 호스트에 분산 → 호스트 장애 시 서비스 유지 │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   Affinity (동일 배치) - 성능 목적                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │   Host 1                                                            │  │
│   │   ┌─────────┐  ┌─────────┐                                         │  │
│   │   │ App-A   │──│ Cache-A │   ← 빈번한 통신이 필요한 VM은 같은 호스트 │  │
│   │   └─────────┘  └─────────┘                                         │  │
│   │                                                                     │  │
│   │   ✓ 네트워크 레이턴시 최소화                                        │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 배치 규칙 정의

| 규칙 ID | 유형 | 대상 VM | 설명 |
|---------|------|--------|------|
| **AA-001** | Anti-Affinity | 웹서버 (동일 테넌트) | HA를 위해 분산 배치 |
| **AA-002** | Anti-Affinity | DB Primary/Standby | 장애 격리 |
| **AF-001** | Affinity | App-Cache 쌍 | 레이턴시 최소화 |

### 3.3 장애 도메인 분리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        장애 도메인 설계                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   장애 도메인 레벨:                                                         │
│                                                                             │
│   Level 1: Host (호스트)                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  단일 호스트 장애 시 해당 호스트의 VM만 영향                         │  │
│   │  → Anti-Affinity로 중요 VM 분산 배치                                 │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   Level 2: Rack (랙) - 설계 문서용                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  랙 단위 장애 (전원, 네트워크) 시 해당 랙의 모든 호스트 영향         │  │
│   │  → 중요 서비스는 다른 랙에 분산 (실제 구현 시)                       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   데모 환경 적용:                                                           │
│   - Host 레벨 Anti-Affinity 적용                                           │
│   - 호스트 장애 시 VM 자동 재시작 (다른 호스트에서)                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 리소스 쿼터

### 4.1 쿼터 정책

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        리소스 쿼터 설계                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   가용 자원 (상한):                                                         │
│   - CPU: 100 코어                                                          │
│   - Memory: 2 TiB (2,048 GB)                                               │
│                                                                             │
│   데모 환경 할당 (VM 10대 기준):                                            │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                     │  │
│   │   테넌트 A: vCPU 8개,  Memory 16GB,  VM 3대 제한                    │  │
│   │   테넌트 B: vCPU 8개,  Memory 16GB,  VM 3대 제한                    │  │
│   │   테넌트 C: vCPU 6개,  Memory 12GB,  VM 2대 제한                    │  │
│   │   관리/운영: vCPU 8개,  Memory 16GB,  VM 3대                        │  │
│   │   ─────────────────────────────────────────────────────────────    │  │
│   │   합계:     vCPU 30개, Memory 60GB,  VM 11대                        │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ※ 데모 환경은 가용 자원의 일부만 사용 (설계 위주 프로젝트)               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 테넌트별 쿼터 상세

| 테넌트 | vCPU | Memory | VM 수 | 디스크 | 용도 |
|--------|------|--------|-------|--------|------|
| **테넌트 A** | 8개 | 16 GB | 3대 | 100 GB | A시청 업무 환경 |
| **테넌트 B** | 8개 | 16 GB | 3대 | 100 GB | B구청 업무 환경 |
| **테넌트 C** | 6개 | 12 GB | 2대 | 80 GB | C군청 업무 환경 |
| **관리/운영** | 8개 | 16 GB | 3대 | 120 GB | 모니터링, 관리 |

### 4.3 쿼터 초과 정책

| 상황 | 정책 |
|------|------|
| 쿼터 80% 도달 | 경고 알림 발송 |
| 쿼터 100% 도달 | 신규 VM 생성 차단 |
| 기존 VM | 계속 운영 (강제 종료 없음) |

---

## 5. 고가용성(HA) 설계

### 5.1 HA 전략

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        고가용성 설계                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   호스트 장애 시나리오:                                                     │
│                                                                             │
│   [정상 상태]                      [장애 발생]                              │
│   ┌─────────┐  ┌─────────┐        ┌─────────┐  ┌─────────┐               │
│   │ Host 1  │  │ Host 2  │        │ Host 1  │  │ Host 2  │               │
│   │ ┌─────┐ │  │ ┌─────┐ │        │   ✗     │  │ ┌─────┐ │               │
│   │ │VM-A │ │  │ │VM-B │ │   ──►  │ 장애!   │  │ │VM-B │ │               │
│   │ └─────┘ │  │ └─────┘ │        │         │  │ │VM-A │ │ ← 자동 이전   │
│   └─────────┘  └─────────┘        └─────────┘  │ └─────┘ │               │
│                                                └─────────┘               │
│                                                                             │
│   HA 동작 순서:                                                             │
│   1. 호스트 장애 감지 (하트비트 타임아웃)                                   │
│   2. 해당 호스트의 VM 목록 확인                                             │
│   3. 다른 호스트에서 VM 재시작                                              │
│   4. 네트워크/스토리지 재연결                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 HA 설정

| 설정 항목 | 값 | 설명 |
|----------|-----|------|
| **HA 활성화** | 예 | 클러스터 레벨 HA 활성화 |
| **장애 감지 시간** | 30초 | 하트비트 타임아웃 |
| **자동 재시작** | 예 | 장애 VM 자동 재시작 |
| **재시작 우선순위** | High/Medium/Low | VM별 우선순위 설정 |

### 5.3 Live Migration

| 항목 | 설명 |
|------|------|
| **목적** | 서비스 중단 없이 VM을 다른 호스트로 이동 |
| **사용 시점** | 호스트 유지보수, 부하 분산 |
| **요구 사항** | 공유 스토리지 (Ceph), 동일 CPU 아키텍처 |

```
Live Migration 프로세스:

   Host 1                              Host 2
   ┌─────────┐                        ┌─────────┐
   │ [VM-A]  │  ──── 메모리 복사 ────► │ [VM-A'] │
   │ Running │                        │ 준비 중 │
   └─────────┘                        └─────────┘
        │                                  │
        │         ◄── 최종 동기화 ──►       │
        │                                  │
   ┌─────────┐                        ┌─────────┐
   │   ---   │                        │ [VM-A]  │
   │ 종료됨  │                        │ Running │
   └─────────┘                        └─────────┘

   - 다운타임: 수 초 이내
   - 스토리지: Ceph RBD (공유)
```

---

## 6. VM 템플릿 및 표준화

### 6.1 VM 템플릿 목록

| 템플릿 ID | OS | 스펙 | 용도 | 포함 패키지 |
|----------|-----|------|------|------------|
| **TPL-WEB** | Ubuntu 22.04 | 2vCPU/4GB | 웹서버 | nginx, node_exporter |
| **TPL-APP** | Ubuntu 22.04 | 4vCPU/8GB | 애플리케이션 | python, docker, node_exporter |
| **TPL-DB** | Ubuntu 22.04 | 4vCPU/8GB | 데이터베이스 | postgresql-client, node_exporter |
| **TPL-MON** | Ubuntu 22.04 | 2vCPU/4GB | 모니터링 | prometheus, grafana |

### 6.2 템플릿 구성 요소

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        VM 템플릿 구성                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   기본 구성 (모든 템플릿 공통):                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  - Ubuntu 22.04 LTS                                                 │  │
│   │  - Cloud-init 설정                                                  │  │
│   │  - SSH 키 기반 인증                                                 │  │
│   │  - 타임존: Asia/Seoul                                               │  │
│   │  - node_exporter (Prometheus 메트릭)                                │  │
│   │  - 보안 업데이트 적용                                                │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   Cloud-init 설정 예시:                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  #cloud-config                                                      │  │
│   │  hostname: ${vm_name}                                               │  │
│   │  timezone: Asia/Seoul                                               │  │
│   │  ssh_authorized_keys:                                               │  │
│   │    - ssh-rsa AAAA... admin@example.com                              │  │
│   │  packages:                                                          │  │
│   │    - prometheus-node-exporter                                       │  │
│   │  runcmd:                                                            │  │
│   │    - systemctl enable prometheus-node-exporter                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.3 VM 명명 규칙

```
{환경}-{테넌트}-{역할}-{번호}

예시:
- dev-a-web-01    : 개발환경, 테넌트A, 웹서버, 1번
- dev-b-app-01    : 개발환경, 테넌트B, 앱서버, 1번
- dev-mgmt-mon-01 : 개발환경, 관리, 모니터링, 1번
```

---

## 7. 검증 워크로드 배포 계획

### 7.1 검증 목적

> 인프라 설계의 정상 동작을 확인하기 위한 샘플 워크로드 배포

| 검증 항목 | 검증 방법 |
|----------|----------|
| **테넌트 격리** | 테넌트 간 네트워크 접근 불가 확인 |
| **리소스 쿼터** | 쿼터 초과 시 VM 생성 차단 확인 |
| **HA** | 호스트 장애 시 VM 자동 재시작 확인 |
| **Anti-Affinity** | VM이 다른 호스트에 분산되었는지 확인 |

### 7.2 검증 환경 VM 구성

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     검증 워크로드 배포 구성                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   테넌트 A (A시청)           테넌트 B (B구청)           테넌트 C (C군청)    │
│   ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐  │
│   │  dev-a-web-01   │       │  dev-b-web-01   │       │  dev-c-web-01   │  │
│   │  (2vCPU/4GB)    │       │  (2vCPU/4GB)    │       │  (2vCPU/4GB)    │  │
│   │  nginx + 샘플앱 │       │  nginx + 샘플앱 │       │  nginx + 샘플앱 │  │
│   └─────────────────┘       └─────────────────┘       └─────────────────┘  │
│   ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐  │
│   │  dev-a-app-01   │       │  dev-b-app-01   │       │  dev-c-app-01   │  │
│   │  (2vCPU/4GB)    │       │  (2vCPU/4GB)    │       │  (2vCPU/4GB)    │  │
│   │  Python API     │       │  Python API     │       │  Python API     │  │
│   └─────────────────┘       └─────────────────┘       └─────────────────┘  │
│                                                                             │
│   관리/운영 영역                                                            │
│   ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐  │
│   │ dev-mgmt-mon-01 │       │ dev-mgmt-db-01  │       │ dev-mgmt-bst-01 │  │
│   │ (2vCPU/4GB)     │       │ (4vCPU/8GB)     │       │ (2vCPU/2GB)     │  │
│   │ Prometheus      │       │ PostgreSQL      │       │ Bastion Host    │  │
│   │ Grafana         │       │ (공용 DB)       │       │ (SSH 접근용)    │  │
│   └─────────────────┘       └─────────────────┘       └─────────────────┘  │
│                                                                             │
│   총 VM: 10대 (테넌트 6대 + 관리 3대 + Bastion 1대)                         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 검증 시나리오

| 시나리오 | 절차 | 예상 결과 |
|----------|------|----------|
| **SC-01: 테넌트 격리** | 테넌트 A VM에서 테넌트 B VM ping | 연결 실패 (차단) |
| **SC-02: 쿼터 테스트** | 테넌트 A에서 쿼터 초과 VM 생성 시도 | 생성 실패 |
| **SC-03: HA 테스트** | 호스트 장애 시뮬레이션 | VM 자동 재시작 |
| **SC-04: Anti-Affinity** | 동일 서비스 VM 배치 확인 | 다른 호스트에 분산 |

---

## 관련 문서

- [01_프로젝트_개요서.md](01_프로젝트_개요서.md)
- [02_팀_역할분담.md](02_팀_역할분담.md)
- [03_상세설계_가이드.md](03_상세설계_가이드.md)
- [05_네트워크_보안_설계서.md](05_네트워크_보안_설계서.md)
- [06_스토리지_설계서.md](06_스토리지_설계서.md)
- [07_AI플랫폼_인프라_설계서.md](07_AI플랫폼_인프라_설계서.md) - AI 플랫폼 및 GPU 설계
