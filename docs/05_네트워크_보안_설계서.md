# 네트워크/보안 설계서

## 공공기관 AI 공동 활용 인프라 구축 프로젝트
### AI 기반 문서 태깅 시스템을 위한 프라이빗 클라우드 설계

| 항목 | 내용 |
|------|------|
| 문서명 | 네트워크/보안 설계서 |
| 버전 | 6.0 |
| 작성일 | 2026-02-10 |
| 담당팀 | 네트워크/보안 팀 |

---

**목차**

1. [설계 개요 및 목표](#1-설계-개요-및-목표)
2. [망분리 설계](#2-망분리-설계)
3. [네트워크 세그멘테이션](#3-네트워크-세그멘테이션)
4. [방화벽 정책](#4-방화벽-정책)
5. [로드밸런서 설계](#5-로드밸런서-설계)
6. [인증 연동 및 접근 제어](#6-인증-연동-및-접근-제어)
7. [암호화 체계](#7-암호화-체계)
8. [감사 및 로깅](#8-감사-및-로깅)

---

## 1. 설계 개요 및 목표

### 1.1 설계 목표

| 목표 | 설명 | 검증 방법 |
|------|------|----------|
| **망분리** | 역할별 네트워크 존 분리 (DMZ/백엔드/AI/DB/스토리지/관리) | VLAN 구성 확인 |
| **부서별 격리** | 앱 레벨 RBAC 기반 데이터 격리 (Hibernate @Filter) | 격리 테스트 |
| **서비스 보호** | AI 서버 내부망 격리, DB 직접 접근 차단 | 접근 제어 확인 |
| **접근 제어** | 기존 내부 인증 연동, RBAC 기반 권한 관리 | 권한 테스트 |
| **암호화** | 전송/저장 데이터 암호화 | 암호화 적용 확인 |

### 1.2 설계 범위

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     네트워크/보안 설계 범위                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   In-Scope (담당 영역)                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  - 망분리 설계 (6개 VLAN, 역할별 네트워크 존)                       │  │
│   │  - 방화벽 정책 (Security Group)                                     │  │
│   │  - 로드밸런서 설계 (nginx Reverse Proxy)                            │  │
│   │  - 내부 인증 연동 설계 (HTTP 헤더 기반)                             │  │
│   │  - 암호화 체계 (TLS, 저장 데이터)                                    │  │
│   │  - 감사 로깅                                                         │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   협업 영역 (다른 팀과 공동)                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  - VM 네트워크 연결 (컴퓨트/개발 팀)                                 │  │
│   │  - 스토리지 네트워크 (스토리지 팀)                                   │  │
│   │  - 모니터링 네트워크 (공통)                                          │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   Out-of-Scope (범위 외)                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  - 로그인 기능 구현 (기존 내부 인증 체계 활용)                       │  │
│   │  - 인증 서버 구축 (기존 시스템 연동)                                 │  │
│   │  - 외부 시스템 연동                                                  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.3 인증 전제 조건

> **중요**: 본 시스템은 기존 내부 인증 체계가 존재함을 전제로 설계됩니다.
> - 로그인 기능은 구현하지 않음
> - 기존 인증 시스템으로부터 사용자 정보를 HTTP 헤더(X-User-ID, X-Department-ID, X-Role)로 수신
> - 인증된 사용자 정보를 기반으로 RBAC 접근 제어 수행

---

## 2. 망분리 설계

### 2.1 네트워크 존 정의

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        네트워크 존 구조 (6개 VLAN)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [기관 내부망]                                                              │
│       │                                                                     │
│       ▼                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  DMZ (VLAN 10)                                                     │  │
│   │  - nginx 웹 서버 (Reverse Proxy + TLS Termination)                 │  │
│   │  - 기관 내부 사용자 접근 구간                                       │  │
│   │  - 기존 인증 시스템 연동 지점 (HTTP 헤더 주입)                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│       │                                                                     │
│       ▼                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  백엔드망 (VLAN 20)                                                │  │
│   │  - Spring Boot App 서버 (REST API + AMQP Consumer)                 │  │
│   │  - RabbitMQ (비동기 메시지 큐)                                     │  │
│   │  - Swagger UI                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│       │                                                                     │
│       ▼                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  AI망 (VLAN 30)                                                    │  │
│   │  - OCR FastAPI (:8001)                                             │  │
│   │  - 태깅 FastAPI (:8000)                                           │  │
│   │  - Stateless AI 서버 (DB/스토리지 직접 접근 불가)                  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  DB망 (VLAN 40)                                                    │  │
│   │  - MariaDB Primary/Replica                                         │  │
│   │  - 메타데이터, 사용자, 태그, Job 관리                              │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  스토리지망 (VLAN 50)                                              │  │
│   │  - Ceph 클러스터 (MON/OSD/RGW)                                    │  │
│   │  - 문서 원본/태깅 결과 저장                                        │  │
│   │  - S3 API (RGW :7480)                                              │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  관리망 (VLAN 100)                                                 │  │
│   │  - SSH 접근 (Bastion 경유)                                         │  │
│   │  - 모니터링, 관리 콘솔 (ABLESTACK Mold)                           │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 VLAN 할당 계획

| VLAN ID | 네트워크 존 | IP 대역 | 용도 | MTU |
|---------|-----------|---------|------|-----|
| **10** | DMZ | 10.0.10.0/24 | nginx 웹 서버 (Reverse Proxy, TLS Termination) | 1500 |
| **20** | 백엔드망 | 10.0.20.0/24 | Spring Boot App 서버, RabbitMQ, AMQP Consumer | 1500 |
| **30** | AI망 | 10.0.30.0/24 | OCR FastAPI(:8001), 태깅 FastAPI(:8000) | 1500 |
| **40** | DB망 | 10.0.40.0/24 | MariaDB Primary/Replica | 1500 |
| **50** | 스토리지망 | 10.0.50.0/24 | Ceph 클러스터 (MON/OSD/RGW) | 9000 |
| **100** | 관리망 | 10.0.100.0/24 | SSH Bastion, ABLESTACK Mold 모니터링 | 1500 |

**총 VLAN 사용: 6개**

> **부서별 격리**: 네트워크 VLAN이 아닌 앱 레벨 RBAC(Hibernate @Filter)로 구현.
> 모든 부서가 동일 VLAN을 공유하되, API 계층에서 X-Department-ID 헤더 기반으로 데이터를 격리한다.

### 2.3 IP 대역 설계

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        IP 대역 할당 상세                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   10.0.10.0/24 (DMZ - VLAN 10)                                             │
│   ├── 10.0.10.1       : 게이트웨이                                          │
│   ├── 10.0.10.10      : dev-svc-web-01 (nginx)                             │
│   └── 10.0.10.11      : dev-svc-web-02 (nginx)                             │
│                                                                             │
│   10.0.20.0/24 (백엔드망 - VLAN 20)                                        │
│   ├── 10.0.20.1       : 게이트웨이                                          │
│   ├── 10.0.20.10      : dev-svc-app-01 (Spring Boot + RabbitMQ)            │
│   └── 10.0.20.11      : dev-svc-app-02 (Spring Boot)                       │
│                                                                             │
│   10.0.30.0/24 (AI망 - VLAN 30)                                            │
│   ├── 10.0.30.1       : 게이트웨이                                          │
│   └── 10.0.30.10      : dev-ai-worker-01 (OCR :8001, 태깅 :8000)          │
│                                                                             │
│   10.0.40.0/24 (DB망 - VLAN 40)                                            │
│   ├── 10.0.40.1       : 게이트웨이                                          │
│   ├── 10.0.40.10      : dev-data-db-pri (MariaDB Primary)                  │
│   └── 10.0.40.11      : dev-data-db-rep (MariaDB Replica)                  │
│                                                                             │
│   10.0.50.0/24 (스토리지망 - VLAN 50)                                      │
│   ├── 10.0.50.1       : 게이트웨이                                          │
│   ├── 10.0.50.10-12   : Ceph MON (3노드)                                   │
│   ├── 10.0.50.20-30   : Ceph OSD                                           │
│   └── 10.0.50.40      : Ceph RGW (S3 API :7480)                           │
│                                                                             │
│   10.0.100.0/24 (관리망 - VLAN 100)                                        │
│   ├── 10.0.100.1      : 게이트웨이                                          │
│   ├── 10.0.100.10     : Bastion Host                                        │
│   └── 10.0.100.20     : ABLESTACK Mold (모니터링)                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.4 네트워크 토폴로지

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        물리 네트워크 토폴로지                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                     [기관 내부 네트워크]                                     │
│                              │                                              │
│                              ▼                                              │
│                     ┌──────────────┐                                        │
│                     │   방화벽     │                                        │
│                     │  (L3/L4 FW)  │                                        │
│                     └──────┬───────┘                                        │
│                            │                                                │
│              ┌─────────────┼─────────────┐                                  │
│              ▼             ▼             ▼                                  │
│        ┌──────────┐  ┌──────────┐  ┌──────────┐                            │
│        │  Core    │──│  Core    │──│  Core    │   (이중화)                  │
│        │ Switch 1 │  │ Switch 2 │  │ Switch 3 │                            │
│        │ (Spine)  │  │ (Spine)  │  │ (Spine)  │                            │
│        └────┬─────┘  └────┬─────┘  └────┬─────┘                            │
│             │             │             │                                   │
│    ┌────────┴─────────────┴─────────────┴────────┐                         │
│    │                                              │                         │
│    ▼                    ▼                    ▼                              │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐                          │
│  │ Leaf SW  │      │ Leaf SW  │      │ Leaf SW  │  (ToR)                   │
│  │ (Rack 1) │      │ (Rack 2) │      │ (Rack 3) │                          │
│  └────┬─────┘      └────┬─────┘      └────┬─────┘                          │
│       │                 │                 │                                 │
│  ┌────┴────┐       ┌────┴────┐       ┌────┴────┐                           │
│  │ HCI     │       │ HCI     │       │ HCI     │                           │
│  │ Node 1  │       │ Node 2  │       │ Node 3  │                           │
│  └─────────┘       └─────────┘       └─────────┘                           │
│                                                                             │
│   VLAN Trunk: 모든 VLAN (10,20,30,40,50,100)                               │
│   Bonding: LACP (4x10G → 40Gbps per node)                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 네트워크 세그멘테이션

### 3.1 세그멘테이션 원칙

> **기본 차단, 명시적 허용 (Default Deny, Explicit Allow)**

부서별 격리는 네트워크 VLAN이 아닌 **앱 레벨 RBAC**로 구현한다. 네트워크 세그멘테이션은 **서비스 역할별**로 적용한다.

| 격리 계층 | 방식 | 설명 |
|-----------|------|------|
| **네트워크** | 역할별 VLAN (6개) | DMZ/백엔드/AI/DB/스토리지/관리 분리 |
| **데이터** | Hibernate @Filter | 모든 JPA 쿼리에 tenant_id 조건 자동 추가 |
| **API** | DepartmentContext | X-Department-ID 헤더 기반 부서 식별 및 데이터 필터링 |

### 3.2 서비스 데이터 흐름 정책

```
┌─────────────────────────────────────────────────────────────────────────────┐
│               문서 태깅 서비스 데이터 흐름 정책                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [기관 내부 사용자]                                                        │
│          │                                                                  │
│          │ HTTPS (443) - 기존 인증 정보 포함                                │
│          ▼                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  DMZ (VLAN 10)                                                     │  │
│   │  ┌──────────────┐   ┌──────────────┐                               │  │
│   │  │ dev-svc-     │   │ dev-svc-     │                               │  │
│   │  │ web-01       │   │ web-02       │                               │  │
│   │  │ (nginx)      │   │ (nginx)      │                               │  │
│   │  └──────┬───────┘   └──────┬───────┘                               │  │
│   └─────────┼──────────────────┼───────────────────────────────────────┘  │
│             │ HTTP 8080        │                                           │
│             ▼                  ▼                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  백엔드망 (VLAN 20)                                                │  │
│   │  ┌──────────────┐   ┌──────────────┐                               │  │
│   │  │ dev-svc-     │   │ dev-svc-     │                               │  │
│   │  │ app-01       │   │ app-02       │                               │  │
│   │  │ Spring Boot  │   │ Spring Boot  │                               │  │
│   │  │ + RabbitMQ   │   │ + AMQP       │                               │  │
│   │  │ + AMQP       │   │   Consumer   │                               │  │
│   │  │   Consumer   │   │              │                               │  │
│   │  └──────┬───────┘   └──────────────┘                               │  │
│   └─────────┼──────────────────────────────────────────────────────────┘  │
│             │                                                              │
│     ┌───────┼───────────────────────────┐                                  │
│     │       │ HTTP 8001/8000            │                                  │
│     │       ▼                           │                                  │
│     │ ┌─────────────────────────┐       │                                  │
│     │ │  AI망 (VLAN 30)         │       │                                  │
│     │ │  dev-ai-worker-01       │       │                                  │
│     │ │  OCR FastAPI :8001      │       │                                  │
│     │ │  태깅 FastAPI :8000     │       │                                  │
│     │ │  (Stateless, DB접근X)   │       │                                  │
│     │ └─────────────────────────┘       │                                  │
│     │                                   │                                  │
│     │  TCP 3306           S3 API 7480   │                                  │
│     ▼                     ▼             │                                  │
│   ┌──────────┐      ┌──────────┐        │                                  │
│   │ DB망     │      │ 스토리지 │        │                                  │
│   │ VLAN 40  │      │ VLAN 50  │        │                                  │
│   │ MariaDB  │      │ Ceph RGW │        │                                  │
│   └──────────┘      └──────────┘        │                                  │
│                                          │                                  │
│   허용 규칙:                                                                │
│   - DMZ → 백엔드망: 8080 (Reverse Proxy)                                   │
│   - 백엔드망 → AI망: 8001, 8000 (AMQP Consumer → AI 서버 HTTP)            │
│   - 백엔드망 → DB망: 3306 (MariaDB)                                       │
│   - 백엔드망 → 스토리지망: 7480 (Ceph S3 API)                             │
│                                                                             │
│   거부 규칙 (핵심):                                                         │
│   ✗ AI망 → DB망: 직접 접근 불가 (Stateless 원칙)                          │
│   ✗ AI망 → 스토리지망: 직접 접근 불가                                     │
│   ✗ DMZ → DB망/스토리지망: 직접 접근 불가                                 │
│   ✗ DMZ → AI망: 직접 접근 불가                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.3 서비스 계층 간 통신 매트릭스

```
┌──────────────────┬─────────┬─────────┬─────────┬─────────┬─────────┐
│ 출발 \ 목적지    │  DMZ    │ 백엔드  │   AI    │   DB    │스토리지 │
├──────────────────┼─────────┼─────────┼─────────┼─────────┼─────────┤
│ DMZ (VLAN 10)    │  허용   │ 허용    │  차단   │  차단   │  차단   │
│ 백엔드 (VLAN 20) │  응답만 │ 허용    │  허용   │  허용   │  허용   │
│ AI (VLAN 30)     │  차단   │ 응답만  │  허용   │  차단   │  차단   │
│ DB (VLAN 40)     │  차단   │ 응답만  │  차단   │  허용   │  차단   │
│ 스토리지 (VLAN 50)│ 차단   │ 응답만  │  차단   │  차단   │  허용   │
└──────────────────┴─────────┴─────────┴─────────┴─────────┴─────────┘
```

> **핵심 원칙**: AI 서버는 Stateless로 동작하며 DB/스토리지에 직접 접근하지 않는다. 모든 데이터 저장은 백엔드(AMQP Consumer)가 수행한다.

---

## 4. 방화벽 정책

### 4.1 계층별 접근 제어 규칙

#### 4.1.1 DMZ 방화벽 규칙 (VLAN 10)

| 규칙 ID | 출발지 | 목적지 | 포트 | 프로토콜 | 동작 |
|---------|--------|--------|------|---------|------|
| **DMZ-001** | 기관 내부망 | DMZ nginx | 443 | TCP | 허용 (HTTPS) |
| **DMZ-002** | DMZ nginx | 백엔드망 App 서버 | 8080 | TCP | 허용 (Reverse Proxy) |
| **DMZ-003** | 관리망 | DMZ | 22 | TCP | 허용 (SSH) |
| **DMZ-999** | ANY | DMZ | ANY | ANY | **거부** |

#### 4.1.2 백엔드망 방화벽 규칙 (VLAN 20)

| 규칙 ID | 출발지 | 목적지 | 포트 | 프로토콜 | 동작 |
|---------|--------|--------|------|---------|------|
| **BE-001** | DMZ nginx | 백엔드망 App 서버 | 8080 | TCP | 허용 (API) |
| **BE-002** | 백엔드망 App 서버 | AI망 AI 서버 | 8001 | TCP | 허용 (OCR) |
| **BE-003** | 백엔드망 App 서버 | AI망 AI 서버 | 8000 | TCP | 허용 (태깅) |
| **BE-004** | 백엔드망 App 서버 | DB망 MariaDB | 3306 | TCP | 허용 (DB) |
| **BE-005** | 백엔드망 App 서버 | 스토리지망 Ceph RGW | 7480 | TCP | 허용 (S3) |
| **BE-006** | 백엔드망 내부 | 백엔드망 내부 | 5672 | TCP | 허용 (RabbitMQ) |
| **BE-007** | 관리망 | 백엔드망 | 22 | TCP | 허용 (SSH) |
| **BE-999** | ANY | 백엔드망 | ANY | ANY | **거부** |

#### 4.1.3 AI망 방화벽 규칙 (VLAN 30)

| 규칙 ID | 출발지 | 목적지 | 포트 | 프로토콜 | 동작 |
|---------|--------|--------|------|---------|------|
| **AI-001** | 백엔드망 App 서버 | AI망 AI 서버 | 8001 | TCP | 허용 (OCR) |
| **AI-002** | 백엔드망 App 서버 | AI망 AI 서버 | 8000 | TCP | 허용 (태깅) |
| **AI-003** | 관리망 | AI망 | 22 | TCP | 허용 (SSH) |
| **AI-004** | AI망 | DB망 | ANY | ANY | **거부** (Stateless 원칙) |
| **AI-005** | AI망 | 스토리지망 | ANY | ANY | **거부** (Stateless 원칙) |
| **AI-999** | ANY | AI망 | ANY | ANY | **거부** |

> **AI-004, AI-005**: AI 서버는 DB/스토리지에 직접 접근할 수 없다. 모든 결과 저장은 백엔드(Spring AMQP Consumer)가 수행한다.

#### 4.1.4 DB망 방화벽 규칙 (VLAN 40)

| 규칙 ID | 출발지 | 목적지 | 포트 | 프로토콜 | 동작 |
|---------|--------|--------|------|---------|------|
| **DB-001** | 백엔드망 App 서버 | DB망 MariaDB | 3306 | TCP | 허용 |
| **DB-002** | DB망 Primary | DB망 Replica | 3306 | TCP | 허용 (복제) |
| **DB-003** | 관리망 | DB망 | 22 | TCP | 허용 (SSH) |
| **DB-999** | ANY | DB망 | ANY | ANY | **거부** |

#### 4.1.5 스토리지망 방화벽 규칙 (VLAN 50)

| 규칙 ID | 출발지 | 목적지 | 포트 | 프로토콜 | 동작 |
|---------|--------|--------|------|---------|------|
| **STG-001** | 백엔드망 App 서버 | 스토리지망 Ceph RGW | 7480 | TCP | 허용 (S3 API) |
| **STG-002** | 스토리지망 | 스토리지망 | 6789 | TCP | 허용 (Ceph MON) |
| **STG-003** | 스토리지망 | 스토리지망 | 6800-7300 | TCP | 허용 (Ceph OSD) |
| **STG-004** | 관리망 | 스토리지망 | 22 | TCP | 허용 (SSH) |
| **STG-999** | ANY | 스토리지망 | ANY | ANY | **거부** |

### 4.2 Security Group 설계

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     Security Group 구성                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   SG-WEB (nginx 웹 서버용) — VLAN 10                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Inbound:                                                           │  │
│   │  - 443/tcp from 기관 내부망                                         │  │
│   │  - 22/tcp from SG-BASTION                                           │  │
│   │  Outbound:                                                          │  │
│   │  - 8080/tcp to SG-API-SERVER                                        │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   SG-API-SERVER (App 서버 + AMQP Consumer용) — VLAN 20                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Inbound:                                                           │  │
│   │  - 8080/tcp from SG-WEB                                             │  │
│   │  - 5672/tcp from SG-API-SERVER (RabbitMQ 내부 통신)                 │  │
│   │  - 22/tcp from SG-BASTION                                           │  │
│   │  Outbound:                                                          │  │
│   │  - 8001/tcp to SG-AI-SERVER (OCR FastAPI)                          │  │
│   │  - 8000/tcp to SG-AI-SERVER (태깅 FastAPI)                         │  │
│   │  - 3306/tcp to SG-DB                                                │  │
│   │  - 7480/tcp to SG-STORAGE (Ceph S3 API)                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   SG-AI-SERVER (OCR/태깅 FastAPI용) — VLAN 30                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Inbound:                                                           │  │
│   │  - 8001/tcp from SG-API-SERVER (OCR 요청)                          │  │
│   │  - 8000/tcp from SG-API-SERVER (태깅 요청)                         │  │
│   │  - 22/tcp from SG-BASTION                                           │  │
│   │  Outbound:                                                          │  │
│   │  - (없음 — Stateless, DB/스토리지 접근 차단)                       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   SG-DB (MariaDB용) — VLAN 40                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Inbound:                                                           │  │
│   │  - 3306/tcp from SG-API-SERVER                                      │  │
│   │  - 3306/tcp from SG-DB (Primary ↔ Replica 복제)                    │  │
│   │  - 22/tcp from SG-BASTION                                           │  │
│   │  Outbound:                                                          │  │
│   │  - 3306/tcp to SG-DB (복제)                                        │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   SG-STORAGE (Ceph 클러스터용) — VLAN 50                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Inbound:                                                           │  │
│   │  - 7480/tcp from SG-API-SERVER (S3 API)                            │  │
│   │  - 6789,6800-7300/tcp from SG-STORAGE (Ceph 내부)                  │  │
│   │  - 22/tcp from SG-BASTION                                           │  │
│   │  Outbound:                                                          │  │
│   │  - 6789,6800-7300/tcp to SG-STORAGE (Ceph 내부)                    │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   SG-BASTION (Bastion Host용) — VLAN 100                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Inbound:                                                           │  │
│   │  - 22/tcp from 관리자 IP (Whitelist)                                │  │
│   │  Outbound:                                                          │  │
│   │  - 22/tcp to ALL (내부망)                                           │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 로드밸런서 설계

### 5.1 로드밸런서 구성

nginx Reverse Proxy를 통해 2대의 App 서버로 트래픽을 분산한다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     로드밸런서 구성 (nginx)                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [기관 내부 사용자]                                                        │
│       │                                                                     │
│       ▼                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  nginx (VLAN 10 - DMZ)                                             │  │
│   │                                                                     │  │
│   │   dev-svc-web-01 / dev-svc-web-02                                   │  │
│   │                                                                     │  │
│   │   URL Routing:                                                      │  │
│   │   - /                → 프론트엔드 정적 파일 서빙                   │  │
│   │   - /api/*           → App 서버 (REST API)                         │  │
│   │   - /api/swagger-ui  → App 서버 (Swagger UI)                       │  │
│   │   - /api/health      → App 서버 (Health Check)                     │  │
│   │                                                                     │  │
│   │   TLS Termination + 인증 헤더 주입                                  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│           │                                                                │
│           ▼                                                                │
│     ┌──────────────────────────────┐                                       │
│     │ App 서버 Pool (Round Robin)  │                                       │
│     │ dev-svc-app-01:8080          │                                       │
│     │ dev-svc-app-02:8080          │                                       │
│     └──────────────────────────────┘                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 로드밸런서 설정

| 항목 | 설정 값 |
|------|--------|
| **알고리즘** | Round Robin |
| **Health Check** | HTTP GET /api/health, 10초 간격, 3회 실패 시 제외 |
| **Session Persistence** | 없음 (Stateless API) |
| **SSL Termination** | nginx에서 TLS 1.3 종료 |
| **Connection Timeout** | 연결 30초, 읽기 60초 |
| **Rate Limiting** | 부서별 1000 req/min (X-Department-ID 기준) |

---

## 6. 인증 연동 및 접근 제어

### 6.1 인증 연동 아키텍처

> **전제**: 본 시스템은 로그인 기능을 구현하지 않습니다.
> 기관의 기존 내부 인증 시스템과 연동하여 HTTP 헤더로 사용자 정보를 수신합니다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     인증 연동 아키텍처                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [기관 내부 인증 시스템] (기존 시스템 - 구현 범위 외)                        │
│         │                                                                   │
│         │ 1. 인증된 사용자 정보를 HTTP 헤더로 주입                           │
│         │    X-User-ID, X-Department-ID, X-Role                             │
│         ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  nginx (VLAN 10 - DMZ)                                             │  │
│   │                                                                     │  │
│   │  2. 클라이언트 헤더 제거 후 인증 시스템 헤더만 전달                  │  │
│   │     proxy_set_header X-User-ID $http_x_user_id;                    │  │
│   │     proxy_set_header X-Department-ID $http_x_department_id;        │  │
│   │     proxy_set_header X-Role $http_x_role;                          │  │
│   │                                                                     │  │
│   └────────┬────────────────────────────────────────────────────────────┘  │
│            │ 3. HTTP 8080 (인증 헤더 포함)                                 │
│            ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Spring Boot App 서버 (VLAN 20 - 백엔드망)                         │  │
│   │                                                                     │  │
│   │  4. TenantContextFilter                                             │  │
│   │     - 헤더 파싱 (X-User-ID, X-Department-ID, X-Role)              │  │
│   │     - 사용자 upsert (최초 접근 시 자동 등록)                       │  │
│   │     - SecurityContext 설정                                          │  │
│   │                                                                     │  │
│   │  5. RbacAuthorizationFilter                                         │  │
│   │     - 역할별 엔드포인트 접근 제어                                  │  │
│   │                                                                     │  │
│   └────────┬────────────────────────────────────────────────────────────┘  │
│            │ 6. 사용자 정보 저장                                           │
│            ▼                                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  MariaDB (VLAN 40 - DB망)                                          │  │
│   │                                                                     │  │
│   │  users 테이블:                                                      │  │
│   │  - id (UUID)                                                        │  │
│   │  - tenant_id (부서 ID)                                              │  │
│   │  - name                                                             │  │
│   │  - role (platform-admin, dept-admin, dept-user, viewer)            │  │
│   │  - first_seen_at, last_seen_at                                      │  │
│   │                                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ※ 로그인 화면, 비밀번호 관리 등은 구현하지 않음                           │
│   ※ 기존 인증 시스템이 주입한 HTTP 헤더를 신뢰                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 RBAC 역할 정의

| 역할 | 권한 | 대상 리소스 |
|------|------|-----------|
| **platform-admin** | 전체 관리 | 모든 리소스, 모든 부서 |
| **dept-admin** | 소속 부서 관리 | 소속 부서 문서, 태그 관리 |
| **dept-user** | 문서 업로드/조회 | 소속 부서 문서 |
| **viewer** | 조회만 | 소속 부서 문서 (읽기 전용) |

### 6.3 권한 매트릭스

| 역할 | 문서 업로드 | 문서 조회 | 태그 조회 | 검색 | Job 관리 | 내 정보 |
|------|-----------|----------|----------|------|---------|--------|
| platform-admin | O (전체) | O (전체) | O (전체) | O (전체) | O (전체) | O |
| dept-admin | O (소속) | O (소속) | O (소속) | O (소속) | O (소속) | O |
| dept-user | O (소속) | O (소속) | O (소속) | O (소속) | O (소속) | O |
| viewer | X | O (소속) | O (소속) | O (소속) | X | O |

### 6.4 부서별 격리 모델

| 격리 항목 | 구현 방식 | 설명 |
|-----------|----------|------|
| **DB 격리** | Hibernate @Filter | 모든 JPA 쿼리에 `WHERE tenant_id = :deptId` 자동 추가 |
| **스토리지 격리** | storage_key 경로 | `documents/{dept-id}/{doc-id}` 경로 기반 분리 |
| **API 격리** | DepartmentContext (ThreadLocal) | 요청별 부서 컨텍스트 설정, 헤더 누락 시 401 |
| **platform-admin 예외** | Hibernate @Filter 미적용 | 전체 데이터 접근 허용 |

---

## 7. 암호화 체계

### 7.1 전송 구간 암호화

| 구간 | 프로토콜 | 설정 |
|------|---------|------|
| **사용자 → nginx** | TLS 1.3 | AES-256-GCM, HSTS 적용 |
| **nginx → App 서버** | HTTP | VLAN 10→20, 방화벽 허용 |
| **App 서버 → AI 서버** | HTTP | VLAN 20→30, 방화벽 허용 |
| **App 서버 → MariaDB** | TCP 3306 | VLAN 20→40, SSL 선택적 |
| **App 서버 → RabbitMQ** | TCP 5672 | VLAN 20 내부 |
| **App 서버 → Ceph** | S3 API | VLAN 20→50, 방화벽 허용 |
| **관리 접속** | SSH | 키 기반 인증, Bastion 경유 |

### 7.2 저장 데이터 암호화

| 대상 | 암호화 방식 | 키 관리 |
|------|-----------|--------|
| **문서 스토리지 (Ceph)** | AES-256-XTS | Ceph 자체 암호화 |
| **메타데이터 DB** | TDE (AES-256) | MariaDB TDE 자체 관리 |
| **백업 데이터** | AES-256 | 별도 키 관리 |

### 7.3 TLS 설정 기준

| 항목 | 설정 |
|------|------|
| 최소 TLS 버전 | TLS 1.3 |
| 암호 스위트 | TLS_AES_256_GCM_SHA384, TLS_CHACHA20_POLY1305_SHA256 |
| HSTS | `max-age=31536000; includeSubDomains` |
| 인증서 | 기관 내부 CA 발급 |
| 인증서 갱신 | 1년 주기, 만료 30일 전 알림 |

---

## 8. 감사 및 로깅

### 8.1 로깅 대상

| 로그 유형 | 수집 대상 | 보관 기간 |
|----------|----------|----------|
| **접근 로그** | API 호출, 문서 접근 | 90일 |
| **변경 로그** | 문서 업로드, 태그 변경, Job 실행 | 1년 |
| **보안 로그** | 인증 실패, 권한 오류, 방화벽 차단 | 1년 |
| **시스템 로그** | OS, 서비스 로그 | 30일 |

### 8.2 로그 형식

```json
{
  "timestamp": "2026-02-10T10:30:00Z",
  "log_type": "document_access",
  "department_id": "dept-a",
  "user_id": "user-001",
  "source_ip": "10.0.10.100",
  "action": "document.upload",
  "resource": "documents/doc-uuid-1234",
  "request_id": "req-uuid-5678",
  "file_size": 2048576,
  "file_type": "application/pdf",
  "result": "success",
  "latency_ms": 250
}
```

### 8.3 로그 수집 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     로그 수집 아키텍처                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   [각 서비스/VM]                                                            │
│        │                                                                    │
│        │ Filebeat                                                           │
│        ▼                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    Logstash                                         │  │
│   │                    (로그 파싱/변환)                                 │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│        │                                                                    │
│        ▼                                                                    │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                    ABLESTACK Mold                                   │  │
│   │                    (로그 조회 / 모니터링 대시보드)                  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.4 알림 정책

| 이벤트 | 심각도 | 조건 | 알림 방법 |
|--------|--------|------|----------|
| 인증 실패 연속 5회 | Critical | 동일 사용자/IP | 즉시 알림 |
| 권한 밖 접근 시도 | High | 타 부서 문서 접근 시도 | 즉시 알림 |
| 업로드 용량 90% 도달 | Medium | 부서별 쿼터 | 10분 내 알림 |
| 방화벽 차단 급증 | Medium | 1분간 100건 이상 | 10분 내 알림 |
| SSL 인증서 만료 임박 | Medium | 30일 이내 만료 | 일일 알림 |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2026-01-30 | 초안 작성 | - |
| 2.0 | 2026-02-02 | AI 플랫폼 네트워크 추가 | - |
| 3.0 | 2026-02-04 | AI 플랫폼 중심 재구성 | - |
| 4.0 | 2026-02-05 | 문서 태깅 시스템용 전면 재구성 | - |
| 5.0 | 2026-02-06 | 사이징 반영: VLAN 구조 변경 | - |
| 5.1 | 2026-02-09 | MariaDB 변경, RabbitMQ 위치 수정 | - |
| 6.0 | 2026-02-10 | VLAN 재설계 (7→6개): 테넌트 VLAN 제거, 역할별 VLAN (DMZ/백엔드/AI/DB/스토리지/관리), AI 서버 Stateless 원칙 (DB/스토리지 접근 차단), Spring AMQP Consumer 반영, 부서별 격리를 앱 레벨 RBAC로 전환 | - |

---

## 관련 문서

- [00_사이징.md](00_사이징.md) - 사이징 가정서 및 요청서
- [00_프로젝트_계획서.md](00_프로젝트_계획서.md) - 프로젝트 계획서
- [00_요구사항_명세서.md](00_요구사항_명세서.md) - 요구사항 명세서
- [01_프로젝트_개요서.md](01_프로젝트_개요서.md) - 프로젝트 개요서
- [02_팀_역할분담.md](02_팀_역할분담.md) - 팀 역할분담
- [03_상세설계_가이드.md](03_상세설계_가이드.md) - 상세설계 가이드
- [04_컴퓨트_설계서.md](04_컴퓨트_설계서.md) - 컴퓨트 설계서
- [06_스토리지_설계서.md](06_스토리지_설계서.md) - 스토리지 설계서
- [07_백엔드_설계서.md](07_백엔드_설계서.md) - 백엔드 설계서
