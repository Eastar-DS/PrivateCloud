# API 설계서

## 공공기관 AI 공동 활용 인프라 구축 프로젝트
### AI 기반 문서 태깅 시스템을 위한 멀티 테넌트 프라이빗 클라우드 설계

| 항목 | 내용 |
|------|------|
| 문서명 | API 설계서 |
| 버전 | 1.0 |
| 작성일 | 2026-02-09 |
| 담당팀 | 컴퓨트/개발 팀 |
| 프로젝트명 | 공공기관 AI 공동 활용 인프라 구축 |
| 상위 문서 | 07_백엔드_설계서.md |

---

**목차**

1. [API 설계 원칙](#1-api-설계-원칙)
2. [전체 엔드포인트 목록](#2-전체-엔드포인트-목록)
3. [주요 엔드포인트 상세](#3-주요-엔드포인트-상세)
4. [표준 응답 형식](#4-표준-응답-형식)
5. [오류 코드 체계](#5-오류-코드-체계)
6. [Swagger 설정](#6-swagger-설정)

---

## 1. API 설계 원칙

### 1.1 RESTful URI 설계 규칙

| 원칙 | 설명 | 예시 |
|------|------|------|
| **명사 사용** | URI에는 동사가 아닌 명사를 사용한다 | `/v1/documents` (O), `/v1/getDocuments` (X) |
| **복수형 사용** | 컬렉션 리소스는 복수형으로 표현한다 | `/v1/documents`, `/v1/tenants` |
| **소문자 + 하이픈** | URI는 소문자와 하이픈(`-`)만 사용한다 | `/v1/audit-logs` (O), `/v1/auditLogs` (X) |
| **계층 구조** | 리소스 간 관계를 경로로 표현한다 | `/v1/documents/{id}/tags` |
| **필터는 쿼리 파라미터** | 검색/필터 조건은 쿼리 파라미터로 전달한다 | `/v1/search?q=keyword&page=0` |

### 1.2 API 버전 관리

- **버전 전략**: URI Path 방식 (`/v1/...`)
- **현재 버전**: `v1`
- **버전 변경 기준**: 하위 호환이 깨지는 변경 발생 시 버전을 올린다
- **하위 호환 변경**: 필드 추가, 선택적 파라미터 추가 등은 기존 버전 내에서 처리한다

### 1.3 공통 요청 헤더

모든 API 엔드포인트(헬스 체크 제외)는 아래 헤더를 필수로 요구한다. 이 헤더들은 외부 인증 계층(Nginx 또는 API Gateway)에서 인증 완료 후 주입되며, 백엔드 애플리케이션은 해당 헤더를 신뢰하고 사용한다 (NFR-05).

| 헤더 | 필수 | 타입 | 설명 |
|------|------|------|------|
| `X-User-ID` | Y | string (UUID) | 요청 사용자 고유 식별자 |
| `X-Department-ID` | Y | string (UUID) | 사용자 소속 부서(테넌트) 식별자 |
| `X-Role` | Y | string | 사용자 역할 (`viewer`, `dept-user`, `dept-admin`, `platform-admin`) |
| `Content-Type` | 조건부 | string | 요청 본문이 있는 경우 필수 |

### 1.4 권한 체계

| 역할 | 설명 | 접근 범위 |
|------|------|----------|
| `viewer` | 읽기 전용 사용자 | 소속 테넌트 문서 조회만 가능 |
| `dept-user` | 부서 일반 사용자 | 소속 테넌트 문서 업로드, 조회, 검색 |
| `dept-admin` | 부서 관리자 | 소속 테넌트 문서 삭제, 태그 교정, 감사 로그 조회 |
| `platform-admin` | 플랫폼 관리자 | 전체 테넌트 관리, 시스템 설정 |

> **권한 상속**: `platform-admin` > `dept-admin` > `dept-user` > `viewer`

### 1.5 API 문서화

- **도구**: SpringDoc OpenAPI 3.0
- **Swagger UI 경로**: `/swagger-ui`
- **API 문서 경로**: `/v3/api-docs`
- **접근 제한**: 개발/스테이징 환경에서만 활성화, 운영 환경에서는 비활성화

---

## 2. 전체 엔드포인트 목록

| Method | URI | 설명 | 최소 권한 | 관련 FR |
|--------|-----|------|----------|---------|
| POST | `/v1/documents` | 문서 업로드 | dept-user | FR-01, FR-02, FR-03 |
| GET | `/v1/documents` | 문서 목록 조회 | dept-user | FR-05 |
| GET | `/v1/documents/{id}` | 문서 상세 조회 | dept-user | FR-02 |
| GET | `/v1/documents/{id}/download` | 문서 다운로드 | dept-user | FR-02 |
| DELETE | `/v1/documents/{id}` | 문서 삭제 | dept-admin | FR-02 |
| POST | `/v1/documents/{id}/versions` | 문서 새 버전 업로드 | dept-user | FR-10 |
| GET | `/v1/documents/{id}/versions` | 문서 버전 이력 조회 | dept-user | FR-10 |
| GET | `/v1/documents/{id}/tags` | 문서 태그 조회 | dept-user | FR-04 |
| PUT | `/v1/documents/{id}/tags` | 태그 수동 교정 | dept-admin | FR-11 |
| POST | `/v1/documents/{id}/retag` | 재태깅 요청 | dept-admin | FR-04 |
| GET | `/v1/search` | 문서 검색 | dept-user | FR-05 |
| GET | `/v1/jobs/{id}` | 태깅 작업 상태 조회 | dept-user | FR-04 |
| GET | `/v1/tenants` | 테넌트 목록 조회 | platform-admin | FR-09 |
| POST | `/v1/tenants` | 테넌트 생성 | platform-admin | FR-09 |
| PUT | `/v1/tenants/{id}` | 테넌트 수정 | platform-admin | FR-09 |
| GET | `/v1/tenants/{id}/quota` | 쿼터 조회 | dept-admin | NFR-11 |
| GET | `/v1/users/me` | 내 정보 조회 | viewer | NFR-05 |
| GET | `/v1/audit-logs` | 감사 로그 조회 | dept-admin | FR-08 |
| GET | `/v1/health` | 헬스 체크 | 없음 | - |
| POST | `/internal/v1/tagging/callback` | AI Worker 태깅 완료 콜백 | internal | FR-04 |

> **내부 API 접근 제한**: `/internal/` 경로는 Nginx에서 외부 접근을 차단하며, 내부 서비스 네트워크에서만 호출 가능하다.

---

## 3. 주요 엔드포인트 상세

### 3.1 POST /v1/documents (문서 업로드)

문서 파일을 업로드하고 AI 자동 태깅을 비동기로 요청한다.

#### 요청

| 항목 | 값 |
|------|-----|
| **Method** | POST |
| **URI** | `/v1/documents` |
| **Content-Type** | `multipart/form-data` |
| **최소 권한** | dept-user |

**요청 필드 (multipart)**

| 필드명 | 타입 | 필수 | 설명 |
|--------|------|------|------|
| `file` | binary | Y | 업로드할 문서 파일 (최대 100MB) |
| `title` | string | Y | 문서 제목 (최대 200자) |
| `description` | string | N | 문서 설명 (최대 1000자) |

**지원 파일 형식**: PDF, Word(docx), Excel(xlsx), 텍스트(txt), 이미지(JPG, PNG)

#### 처리 흐름

```
1. 요청 검증 (파일 크기, 형식, 필수 필드)
2. SHA-256 해시 계산 (중복 문서 검사, NFR-10)
3. 테넌트 쿼터 확인 (NFR-11)
4. Ceph Object Storage에 파일 업로드
5. MariaDB에 문서 메타데이터 저장
6. RabbitMQ에 태깅 작업 메시지 발행 (NFR-06)
7. 감사 로그 기록 (FR-08)
8. 응답 반환 (document_id, job_id)
```

#### 응답 (201 Created)

```json
{
  "success": true,
  "data": {
    "document_id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "2026년 1분기 예산 계획서",
    "description": "부서별 예산 배분 계획",
    "file_name": "budget_2026_q1.pdf",
    "file_size": 2048576,
    "file_hash": "a3f2b8c1d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1",
    "mime_type": "application/pdf",
    "status": "PENDING",
    "job_id": "660e8400-e29b-41d4-a716-446655440001",
    "uploaded_by": "user-001",
    "tenant_id": "dept-a-001",
    "created_at": "2026-02-09T10:30:00+09:00"
  },
  "meta": {
    "request_id": "req-abc123-def456",
    "timestamp": "2026-02-09T10:30:00.123+09:00"
  }
}
```

#### HTTP 상태 코드

| 코드 | 조건 |
|------|------|
| 201 | 업로드 성공 |
| 400 | 필수 필드 누락, 파일 형식 미지원 |
| 401 | 인증 헤더 누락 |
| 403 | 권한 부족 |
| 409 | 동일 해시 문서 중복 |
| 413 | 파일 크기 초과 (100MB) 또는 쿼터 초과 |
| 500 | 내부 서버 오류 |

#### 비즈니스 규칙

- 동일 테넌트 내에서 동일 SHA-256 해시를 가진 문서가 이미 존재하면 `409 DUPLICATE_DOCUMENT` 반환
- 파일 크기는 100MB를 초과할 수 없다 (Nginx 및 애플리케이션 레벨에서 이중 검증)
- 테넌트 스토리지 쿼터(500GB)를 초과하면 `413 QUOTA_EXCEEDED` 반환
- 업로드 완료 시 RabbitMQ `tagging.request` 큐에 메시지를 발행하여 비동기 태깅을 시작한다
- 모든 업로드 행위는 감사 로그에 기록된다

#### 요청 예시

```bash
curl -X POST https://smartdocs.example.com/v1/documents \
  -H "X-User-ID: user-001" \
  -H "X-Department-ID: dept-a-001" \
  -H "X-Role: dept-user" \
  -F "file=@budget_2026_q1.pdf" \
  -F "title=2026년 1분기 예산 계획서" \
  -F "description=부서별 예산 배분 계획"
```

**오류 응답 예시 (파일 크기 초과)**

```json
{
  "success": false,
  "error": {
    "code": "FILE_TOO_LARGE",
    "message": "파일 크기가 허용 한도를 초과했습니다",
    "detail": "최대 허용 크기: 100MB, 요청 파일 크기: 150MB"
  },
  "meta": {
    "request_id": "req-abc123-def789",
    "timestamp": "2026-02-09T10:31:00.456+09:00"
  }
}
```

---

### 3.2 GET /v1/search (문서 검색)

태그, 키워드, 날짜 등 다양한 조건으로 문서를 검색한다. MariaDB Full-text Search를 활용하며, 테넌트 격리가 자동 적용된다.

#### 요청

| 항목 | 값 |
|------|-----|
| **Method** | GET |
| **URI** | `/v1/search` |
| **최소 권한** | dept-user |

**쿼리 파라미터**

| 파라미터 | 타입 | 필수 | 기본값 | 설명 |
|---------|------|------|--------|------|
| `q` | string | N | - | 키워드 검색어 (제목, 설명 대상 Full-text Search) |
| `tags` | string | N | - | 태그 필터 (쉼표 구분, 예: `예산,계획`) |
| `from_date` | string (ISO 8601) | N | - | 검색 시작일 |
| `to_date` | string (ISO 8601) | N | - | 검색 종료일 |
| `status` | string | N | - | 문서 상태 필터 (`PENDING`, `COMPLETED`, `FAILED`) |
| `page` | integer | N | 0 | 페이지 번호 (0부터 시작) |
| `size` | integer | N | 20 | 페이지 크기 (최대 100) |
| `sort` | string | N | `created_at,desc` | 정렬 기준 |

#### 응답 (200 OK)

```json
{
  "success": true,
  "data": [
    {
      "document_id": "550e8400-e29b-41d4-a716-446655440000",
      "title": "2026년 1분기 예산 계획서",
      "description": "부서별 예산 배분 계획",
      "file_name": "budget_2026_q1.pdf",
      "file_size": 2048576,
      "mime_type": "application/pdf",
      "status": "COMPLETED",
      "tags": [
        { "name": "예산", "confidence": 0.95, "source": "AI" },
        { "name": "계획서", "confidence": 0.88, "source": "AI" },
        { "name": "1분기", "confidence": 0.82, "source": "MANUAL" }
      ],
      "uploaded_by": "user-001",
      "created_at": "2026-02-09T10:30:00+09:00",
      "updated_at": "2026-02-09T10:30:15+09:00"
    }
  ],
  "meta": {
    "request_id": "req-search-001",
    "timestamp": "2026-02-09T11:00:00.789+09:00"
  },
  "pagination": {
    "page": 0,
    "size": 20,
    "total_elements": 156,
    "total_pages": 8
  }
}
```

#### HTTP 상태 코드

| 코드 | 조건 |
|------|------|
| 200 | 검색 성공 (결과 0건도 포함) |
| 400 | 잘못된 쿼리 파라미터 (날짜 형식 오류 등) |
| 401 | 인증 헤더 누락 |
| 403 | 권한 부족 |
| 500 | 내부 서버 오류 |

#### 비즈니스 규칙

- `X-Department-ID` 헤더를 기반으로 테넌트 필터가 자동 적용된다 (다른 테넌트 문서는 검색 불가)
- `platform-admin` 역할은 전체 테넌트 검색이 가능하다
- `q` 파라미터가 있을 때 MariaDB Full-text Search (MATCH ... AGAINST)를 사용한다
- `tags` 파라미터는 OR 조건으로 매칭된다 (태그 하나라도 일치하면 결과에 포함)
- `page` x `size`의 최대 오프셋은 10,000건으로 제한한다 (Deep Paging 방지)

#### 요청 예시

```bash
curl -X GET "https://smartdocs.example.com/v1/search?q=예산&tags=계획서&from_date=2026-01-01&to_date=2026-12-31&page=0&size=20&sort=created_at,desc" \
  -H "X-User-ID: user-001" \
  -H "X-Department-ID: dept-a-001" \
  -H "X-Role: dept-user"
```

---

### 3.3 GET /v1/jobs/{id} (태깅 작업 상태 조회)

AI 자동 태깅 작업의 현재 상태를 조회한다. 문서 업로드 후 클라이언트가 폴링하여 태깅 완료 여부를 확인한다.

#### 요청

| 항목 | 값 |
|------|-----|
| **Method** | GET |
| **URI** | `/v1/jobs/{id}` |
| **최소 권한** | dept-user |

**경로 파라미터**: `id` - 태깅 작업 ID (UUID, 업로드 응답의 `job_id`)

#### 작업 상태 정의

| 상태 | 설명 |
|------|------|
| `PENDING` | RabbitMQ 큐에 등록됨, AI Worker가 아직 수신하지 않음 |
| `PROCESSING` | AI Worker가 작업을 수신하여 태깅 처리 중 |
| `COMPLETED` | 태깅 완료, 태그 결과가 DB에 저장됨 |
| `FAILED` | 태깅 실패 (파일 손상, 모델 오류 등) |

#### 응답 (200 OK) - 태깅 완료 예시

```json
{
  "success": true,
  "data": {
    "job_id": "660e8400-e29b-41d4-a716-446655440001",
    "document_id": "550e8400-e29b-41d4-a716-446655440000",
    "status": "COMPLETED",
    "tags": [
      { "name": "예산", "confidence": 0.95 },
      { "name": "계획서", "confidence": 0.88 },
      { "name": "공공기관", "confidence": 0.76 }
    ],
    "model_version": "kobert-tag-v1.2",
    "created_at": "2026-02-09T10:30:00+09:00",
    "processed_at": "2026-02-09T10:30:15+09:00"
  },
  "meta": {
    "request_id": "req-job-001",
    "timestamp": "2026-02-09T10:31:00.123+09:00"
  }
}
```

> **참고**: `PROCESSING` 상태에서는 `tags`가 빈 배열, `model_version`과 `processed_at`이 `null`로 반환된다. `FAILED` 상태에서는 `error_message` 필드가 추가된다.

#### HTTP 상태 코드

| 코드 | 조건 |
|------|------|
| 200 | 조회 성공 (모든 상태에서 200 반환) |
| 401 | 인증 헤더 누락 |
| 403 | 다른 테넌트의 작업 조회 시도 |
| 404 | 작업 ID 미존재 |

#### 비즈니스 규칙

- 클라이언트는 `status`가 `COMPLETED` 또는 `FAILED`가 될 때까지 주기적으로 폴링한다 (권장 간격: 2초)
- 작업이 속한 문서의 테넌트와 요청자의 테넌트가 다르면 `403 TENANT_MISMATCH` 반환
- `FAILED` 상태의 작업은 `POST /v1/documents/{id}/retag`로 재시도할 수 있다

---

### 3.4 PUT /v1/documents/{id}/tags (태그 수동 교정)

AI가 생성한 태그를 부서 관리자가 수동으로 추가하거나 제거한다 (FR-11).

#### 요청

| 항목 | 값 |
|------|-----|
| **Method** | PUT |
| **URI** | `/v1/documents/{id}/tags` |
| **Content-Type** | `application/json` |
| **최소 권한** | dept-admin |

**경로 파라미터**: `id` - 문서 ID (UUID)

**요청 본문**

```json
{
  "tags": [
    { "name": "긴급", "action": "ADD" },
    { "name": "공공기관", "action": "REMOVE" }
  ]
}
```

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `tags` | array | Y | 태그 변경 목록 |
| `tags[].name` | string | Y | 태그명 (최대 50자) |
| `tags[].action` | string | Y | 변경 유형: `ADD` (추가) 또는 `REMOVE` (제거) |

#### 응답 (200 OK)

```json
{
  "success": true,
  "data": {
    "document_id": "550e8400-e29b-41d4-a716-446655440000",
    "tags": [
      { "name": "예산", "confidence": 0.95, "source": "AI" },
      { "name": "계획서", "confidence": 0.88, "source": "AI" },
      { "name": "긴급", "confidence": 1.0, "source": "MANUAL" }
    ],
    "updated_by": "admin-001",
    "updated_at": "2026-02-09T14:00:00+09:00"
  },
  "meta": {
    "request_id": "req-tag-001",
    "timestamp": "2026-02-09T14:00:00.123+09:00"
  }
}
```

#### HTTP 상태 코드

| 코드 | 조건 |
|------|------|
| 200 | 태그 교정 성공 |
| 400 | 잘못된 요청 (action 값 오류, 태그명 초과 등) |
| 401 | 인증 헤더 누락 |
| 403 | 권한 부족 (dept-admin 미만) 또는 타 테넌트 문서 |
| 404 | 문서 미존재 |

#### 비즈니스 규칙

- `dept-admin` 이상 역할만 태그를 교정할 수 있다
- 수동 추가된 태그의 `source`는 `MANUAL`, `confidence`는 `1.0`으로 설정된다
- `REMOVE` 시 해당 태그가 존재하지 않으면 무시한다 (멱등성 보장)
- 태그 교정 이력은 감사 로그에 기록된다 (FR-08)
- 수동 교정 데이터는 AI 모델 개선(경량 파인튜닝)에 활용될 수 있다 (NFR-03)

#### 요청 예시

```bash
curl -X PUT "https://smartdocs.example.com/v1/documents/550e8400-e29b-41d4-a716-446655440000/tags" \
  -H "X-User-ID: admin-001" \
  -H "X-Department-ID: dept-a-001" \
  -H "X-Role: dept-admin" \
  -H "Content-Type: application/json" \
  -d '{
    "tags": [
      { "name": "긴급", "action": "ADD" },
      { "name": "공공기관", "action": "REMOVE" }
    ]
  }'
```

---

### 3.5 POST /internal/v1/tagging/callback (AI Worker 콜백)

AI Worker가 태깅 처리를 완료한 후 App 서버에 결과를 전달하는 내부 전용 콜백 엔드포인트이다.

#### 요청

| 항목 | 값 |
|------|-----|
| **Method** | POST |
| **URI** | `/internal/v1/tagging/callback` |
| **Content-Type** | `application/json` |
| **접근 제한** | 내부 네트워크 전용 (Nginx에서 외부 차단, 서비스망 10.10.20.0/24만 허용) |

**요청 본문**

```json
{
  "job_id": "660e8400-e29b-41d4-a716-446655440001",
  "status": "COMPLETED",
  "tags": [
    { "name": "예산", "confidence": 0.95 },
    { "name": "계획서", "confidence": 0.88 },
    { "name": "공공기관", "confidence": 0.76 }
  ],
  "model_version": "kobert-tag-v1.2"
}
```

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `job_id` | string (UUID) | Y | 태깅 작업 ID |
| `status` | string | Y | 처리 결과: `COMPLETED` 또는 `FAILED` |
| `tags` | array | 조건부 | 태그 목록 (`COMPLETED` 시 필수) |
| `tags[].name` | string | Y | 태그명 |
| `tags[].confidence` | number (0.0~1.0) | Y | 태그 신뢰도 |
| `model_version` | string | Y | 사용된 AI 모델 버전 |
| `error_message` | string | 조건부 | 오류 메시지 (`FAILED` 시 필수) |

#### 응답 (200 OK)

```json
{
  "success": true,
  "data": {
    "job_id": "660e8400-e29b-41d4-a716-446655440001",
    "received": true
  },
  "meta": {
    "request_id": "req-callback-001",
    "timestamp": "2026-02-09T10:30:15.123+09:00"
  }
}
```

#### 처리 흐름

```
1. job_id로 작업 존재 여부 확인
2. 작업 상태를 COMPLETED 또는 FAILED로 갱신
3. COMPLETED: confidence >= 0.5인 태그만 필터링하여 DB 저장, 문서 상태 갱신
4. FAILED: error_message 저장, 문서 상태를 FAILED로 갱신
5. 처리 완료 시각(processed_at) 기록
```

#### HTTP 상태 코드

| 코드 | 조건 |
|------|------|
| 200 | 콜백 처리 성공 |
| 400 | 잘못된 요청 본문 |
| 404 | job_id에 해당하는 작업 미존재 |

#### 비즈니스 규칙

- 외부 네트워크에서는 접근 불가 (Nginx `deny all` 설정)
- `confidence`가 0.5 미만인 태그는 저장하지 않는다
- 동일 `job_id`로 중복 콜백 수신 시 최초 1회만 처리한다 (멱등성)
- 콜백 미수신 시 타임아웃 처리: 작업 생성 후 5분 이내 콜백이 없으면 `FAILED`로 전환 (스케줄러)

---

## 4. 표준 응답 형식

모든 API 응답은 일관된 JSON 구조(Envelope Pattern)를 따른다.

### 4.1 성공 응답 (단건)

```json
{
  "success": true,
  "data": { ... },
  "meta": {
    "request_id": "req-abc123-def456",
    "timestamp": "2026-02-09T10:30:00.123+09:00"
  }
}
```

### 4.2 성공 응답 (목록/페이지네이션)

```json
{
  "success": true,
  "data": [ ... ],
  "meta": {
    "request_id": "req-abc123-def456",
    "timestamp": "2026-02-09T10:30:00.123+09:00"
  },
  "pagination": {
    "page": 0,
    "size": 20,
    "total_elements": 156,
    "total_pages": 8
  }
}
```

### 4.3 오류 응답

```json
{
  "success": false,
  "error": {
    "code": "DOC_NOT_FOUND",
    "message": "문서를 찾을 수 없습니다",
    "detail": "document_id: 550e8400-e29b-41d4-a716-446655440999"
  },
  "meta": {
    "request_id": "req-abc123-def456",
    "timestamp": "2026-02-09T10:30:00.123+09:00"
  }
}
```

### 4.4 응답 필드 설명

| 필드 | 타입 | 설명 |
|------|------|------|
| `success` | boolean | 요청 성공 여부 |
| `data` | object / array | 응답 데이터 (성공 시) |
| `error` | object | 오류 정보 (실패 시) |
| `error.code` | string | 오류 코드 (프로그래밍 용도) |
| `error.message` | string | 사용자 친화적 오류 메시지 (한국어) |
| `error.detail` | string | 상세 오류 정보 (디버깅 용도, 운영 시 생략 가능) |
| `meta.request_id` | string | 요청 추적 ID (감사 로그 연동) |
| `meta.timestamp` | string (ISO 8601) | 응답 생성 시각 |
| `pagination` | object | 페이지네이션 정보 (목록 조회 시에만 포함) |

---

## 5. 오류 코드 체계

### 5.1 오류 코드 목록

| HTTP 상태 | 오류 코드 | 설명 |
|----------|----------|------|
| 400 | `INVALID_REQUEST` | 잘못된 요청 (필수 필드 누락, 형식 오류) |
| 400 | `INVALID_FILE_TYPE` | 지원하지 않는 파일 형식 |
| 400 | `FILE_TOO_LARGE` | 파일 크기 초과 (100MB 초과) |
| 401 | `AUTH_REQUIRED` | 인증 헤더 누락 (`X-User-ID` 등) |
| 403 | `ACCESS_DENIED` | 권한 부족 (역할 미충족) |
| 403 | `TENANT_MISMATCH` | 타 테넌트 리소스 접근 시도 |
| 404 | `DOC_NOT_FOUND` | 문서 미존재 |
| 404 | `JOB_NOT_FOUND` | 태깅 작업 미존재 |
| 409 | `DUPLICATE_DOCUMENT` | 동일 해시(SHA-256) 문서 중복 |
| 413 | `QUOTA_EXCEEDED` | 테넌트 스토리지 쿼터 초과 |
| 500 | `INTERNAL_ERROR` | 내부 서버 오류 |
| 503 | `SERVICE_UNAVAILABLE` | 외부 서비스 연결 실패 (Ceph, RabbitMQ 등) |

### 5.2 오류 처리 원칙

| 원칙 | 설명 |
|------|------|
| **일관된 형식** | 모든 오류는 동일한 JSON 구조로 반환한다 |
| **한국어 메시지** | `error.message`는 최종 사용자에게 노출 가능한 한국어 메시지이다 |
| **상세 정보 분리** | `error.detail`은 개발/디버깅용이며, 운영 환경에서는 민감 정보를 제외한다 |
| **요청 추적** | `meta.request_id`를 통해 감사 로그와 연동하여 오류 추적이 가능하다 |
| **멱등성** | 중복 요청 시 동일한 오류 코드와 메시지를 반환한다 |

---

## 6. Swagger 설정

### 6.1 SpringDoc OpenAPI 설정

**의존성 (build.gradle)**

```groovy
implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0'
```

**application.yml**

```yaml
springdoc:
  api-docs:
    path: /v3/api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui
    enabled: true
    tags-sorter: alpha
    operations-sorter: method
  group-configs:
    - group: document-api
      display-name: "문서 관리 API"
      paths-to-match: ["/v1/documents/**"]
    - group: search-api
      display-name: "검색 API"
      paths-to-match: ["/v1/search/**"]
    - group: job-api
      display-name: "작업 상태 API"
      paths-to-match: ["/v1/jobs/**"]
    - group: tenant-api
      display-name: "테넌트 관리 API"
      paths-to-match: ["/v1/tenants/**"]
    - group: system-api
      display-name: "시스템 API"
      paths-to-match: ["/v1/users/**", "/v1/audit-logs/**", "/v1/health"]
```

### 6.2 OpenAPI 메타 정보

```java
@Configuration
public class OpenApiConfig {

    @Bean
    public OpenAPI openAPI() {
        return new OpenAPI()
            .info(new Info()
                .title("SmartDocs API")
                .description("AI 기반 문서 자동 태깅 시스템 REST API")
                .version("v1.0")
                .contact(new Contact()
                    .name("컴퓨트/개발 팀")
                    .email("dev@example.com")))
            .addSecurityItem(new SecurityRequirement().addList("headerAuth"))
            .components(new Components()
                .addSecuritySchemes("headerAuth",
                    new SecurityScheme()
                        .type(SecurityScheme.Type.APIKEY)
                        .in(SecurityScheme.In.HEADER)
                        .name("X-User-ID")
                        .description("사용자 식별 헤더")));
    }
}
```

### 6.3 환경별 Swagger 활성화 설정

| 환경 | Swagger UI | API Docs | 비고 |
|------|-----------|----------|------|
| 개발 (dev) | 활성화 | 활성화 | 모든 기능 접근 가능 |
| 스테이징 (staging) | 활성화 | 활성화 | 검증 목적 |
| 운영 (prod) | **비활성화** | **비활성화** | 보안상 비활성화 |

**운영 환경 비활성화 (application-prod.yml)**

```yaml
springdoc:
  api-docs:
    enabled: false
  swagger-ui:
    enabled: false
```

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2026-02-09 | 초안 작성 | 컴퓨트/개발 팀 |

---

## 관련 문서

- [00_요구사항_명세서.md](00_요구사항_명세서.md) - 요구사항 명세서
- [04_컴퓨트_설계서.md](04_컴퓨트_설계서.md) - 컴퓨트 설계서
- [05_네트워크_보안_설계서.md](05_네트워크_보안_설계서.md) - 네트워크/보안 설계서
- [06_스토리지_설계서.md](06_스토리지_설계서.md) - 스토리지 설계서
- [07_백엔드_설계서.md](07_백엔드_설계서.md) - 백엔드 설계서 (상위 문서)
