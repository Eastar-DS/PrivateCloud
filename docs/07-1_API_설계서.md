# API 설계서

## 공공기관 AI 공동 활용 인프라 구축 프로젝트
### AI 기반 문서 태깅 시스템을 위한 멀티 테넌트 프라이빗 클라우드 설계

| 항목 | 내용 |
|------|------|
| 문서명 | API 설계서 |
| 버전 | 2.0 |
| 작성일 | 2026-02-10 |
| 프로젝트명 | 공공기관 AI 공동 활용 인프라 구축 |
| 상위 문서 | 07_백엔드_설계서.md |

---

**목차**

1. [API 설계 원칙](#1-api-설계-원칙)
2. [엔드포인트 목록](#2-엔드포인트-목록)
3. [API 상세 명세](#3-api-상세-명세)
4. [공통 응답 형식](#4-공통-응답-형식)
5. [에러 코드](#5-에러-코드)
6. [API 문서화 (Swagger)](#6-api-문서화-swagger)

---

## 1. API 설계 원칙

### 1.1 기본 원칙

| 항목 | 설명 |
|------|------|
| **프리픽스** | `/api/` |
| **프로토콜** | HTTPS (nginx TLS Termination → 내부 HTTP) |
| **인증** | HTTP 헤더 기반 (X-User-ID, X-Department-ID, X-Role) |
| **형식** | JSON (Content-Type: application/json) |
| **파일 업로드** | multipart/form-data |
| **인코딩** | UTF-8 |
| **날짜** | ISO 8601 (예: 2026-02-10T10:30:00Z) |

### 1.2 URL 명명 규칙

| 규칙 | 예시 |
|------|------|
| 리소스명은 복수형 | `/api/documents`, `/api/jobs` |
| 소문자 + 하이픈 | `/api/search/documents` |
| 리소스 ID는 경로 파라미터 | `/api/documents/{documentId}` |
| 필터/검색은 쿼리 파라미터 | `/api/search/documents?q=예산&page=0` |

---

## 2. 엔드포인트 목록

### 2.1 MVP 엔드포인트 (11개)

| # | 리소스 | Method | URI | 설명 | 최소 권한 |
|---|--------|--------|-----|------|----------|
| 1 | Document | POST | `/api/documents` | 문서 업로드 (텍스트/파일, Job 자동 생성) | dept-user |
| 2 | Document | GET | `/api/documents` | 문서 목록 조회 | dept-user |
| 3 | Document | GET | `/api/documents/{documentId}` | 문서 상세 조회 (태깅 상태 포함) | dept-user |
| 4 | Tag | GET | `/api/documents/{documentId}/tags` | 문서 태그 조회 | dept-user |
| 5 | OCR | GET | `/api/documents/{documentId}/ocr` | OCR 추출 텍스트 조회 | dept-user |
| 6 | Search | GET | `/api/search/documents` | 문서 검색 | dept-user |
| 7 | Job | POST | `/api/jobs` | OCR/태깅 Job 등록 (재태깅용) | dept-user |
| 8 | Job | GET | `/api/jobs/{jobId}` | Job 처리 상태 조회 | dept-user |
| 9 | Job | POST | `/api/jobs/{jobId}/retry` | Job 재실행 요청 | dept-user |
| 10 | User | GET | `/api/users/me` | 내 정보 조회 | viewer |
| 11 | System | GET | `/api/health` | 헬스 체크 | 없음 |

### 2.2 MVP 제외 엔드포인트

다음 기능은 MVP 범위에서 제외하며, 향후 확장 시 구현한다.

| 기능 | 사유 |
|------|------|
| 문서 다운로드 (`GET /api/documents/{id}/download`) | MVP 범위 외 |
| 문서 삭제 (`DELETE /api/documents/{id}`) | MVP 범위 외 |
| 문서 버전 관리 | MVP 범위 외 |
| 수동 태그 편집 (`PUT /api/documents/{id}/tags`) | MVP 범위 외 |
| 테넌트 관리 CRUD | MVP에서 테넌트 고정 (dept-a/b/c) |
| 감사 로그 조회 | MVP 범위 외 |

---

## 3. API 상세 명세

### 3.1 POST /api/documents — 문서 업로드

문서를 업로드하고 OCR/태깅 Job을 자동으로 생성한다. **텍스트 작성**과 **파일 업로드** 두 가지 방식을 지원한다.

#### 방법 1: 파일 업로드

```
POST /api/documents
Content-Type: multipart/form-data
```

| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| file | MultipartFile | O | 업로드할 파일 (최대 20MB) |
| title | String | O | 문서 제목 (최대 500자) |
| description | String | X | 문서 설명 (최대 1000자) |

#### 방법 2: 텍스트 작성

```
POST /api/documents
Content-Type: application/json
```

```json
{
  "title": "2026년도 예산 집행 계획",
  "content": "본 문서는 2026년도 예산 집행에 관한 계획을 기술합니다...",
  "description": "예산 관련 문서"
}
```

| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| title | String | O | 문서 제목 (최대 500자) |
| content | String | O | 문서 내용 (최대 100,000자) |
| description | String | X | 문서 설명 (최대 1000자) |

#### Response (201 Created)

```json
{
  "success": true,
  "data": {
    "documentId": "7c9e6679-7425-40de-944b-e07fc1f90ae7",
    "title": "2026년도 예산 집행 계획",
    "documentType": "pdf",
    "taggingStatus": "PENDING",
    "jobId": "550e8400-e29b-41d4-a716-446655440000",
    "createdAt": "2026-02-10T10:30:00Z"
  }
}
```

#### 파일 업로드 제약

| 항목 | 제한 |
|------|------|
| 최대 파일 크기 | **20MB** |
| 텍스트 최대 길이 | **100,000자** |
| 허용 확장자 | pdf, docx, doc, xlsx, xls, pptx, ppt, txt, rtf, hwp, jpg, jpeg, png, tiff, bmp |
| Content-Type 검증 | Magic Bytes 기반 |

---

### 3.2 GET /api/documents — 문서 목록 조회

소속 테넌트의 문서 목록을 페이지네이션으로 조회한다.

```
GET /api/documents?page=0&size=20&sort=createdAt,desc
```

| 파라미터 | 타입 | 필수 | 기본값 | 설명 |
|---------|------|------|-------|------|
| page | Integer | X | 0 | 페이지 번호 (0-based) |
| size | Integer | X | 20 | 페이지 크기 (최대 100) |
| sort | String | X | createdAt,desc | 정렬 기준 |
| status | String | X | - | 태깅 상태 필터 (PENDING/PROCESSING/COMPLETED/FAILED) |

#### Response (200 OK)

```json
{
  "success": true,
  "data": {
    "content": [
      {
        "documentId": "7c9e6679-...",
        "title": "2026년도 예산 집행 계획",
        "documentType": "pdf",
        "fileName": "budget_2026.pdf",
        "fileSize": 2048576,
        "taggingStatus": "COMPLETED",
        "createdAt": "2026-02-10T10:30:00Z"
      }
    ],
    "page": 0,
    "size": 20,
    "totalElements": 45,
    "totalPages": 3
  }
}
```

---

### 3.3 GET /api/documents/{documentId} — 문서 상세 조회

문서의 상세 정보와 태깅 상태를 조회한다.

```
GET /api/documents/7c9e6679-7425-40de-944b-e07fc1f90ae7
```

#### Response (200 OK)

```json
{
  "success": true,
  "data": {
    "documentId": "7c9e6679-...",
    "title": "2026년도 예산 집행 계획",
    "description": "예산 관련 문서",
    "documentType": "pdf",
    "fileName": "budget_2026.pdf",
    "fileSize": 2048576,
    "mimeType": "application/pdf",
    "taggingStatus": "COMPLETED",
    "uploadedBy": "user-001",
    "createdAt": "2026-02-10T10:30:00Z",
    "updatedAt": "2026-02-10T10:30:05Z"
  }
}
```

---

### 3.4 GET /api/documents/{documentId}/tags — 문서 태그 조회

문서에 부여된 AI 태그 목록을 조회한다.

```
GET /api/documents/7c9e6679-7425-40de-944b-e07fc1f90ae7/tags
```

#### Response (200 OK)

```json
{
  "success": true,
  "data": [
    {
      "tagId": 1,
      "name": "예산",
      "confidence": 0.9521,
      "source": "AI",
      "modelVersion": "kobert-v1.0",
      "createdAt": "2026-02-10T10:30:05Z"
    },
    {
      "tagId": 2,
      "name": "계획서",
      "confidence": 0.8734,
      "source": "AI",
      "modelVersion": "kobert-v1.0",
      "createdAt": "2026-02-10T10:30:05Z"
    }
  ]
}
```

---

### 3.5 GET /api/documents/{documentId}/ocr — OCR 결과 조회

문서의 OCR 추출 텍스트를 조회한다. OCR이 완료되지 않았거나 텍스트 입력 문서인 경우 원문 텍스트를 반환한다.

```
GET /api/documents/7c9e6679-7425-40de-944b-e07fc1f90ae7/ocr
```

#### Response (200 OK)

```json
{
  "success": true,
  "data": {
    "documentId": "7c9e6679-...",
    "extractedText": "이 문서는 2026년도 예산 집행 계획에 관한...",
    "pageCount": 5,
    "ocrStatus": "COMPLETED"
  }
}
```

---

### 3.6 GET /api/search/documents — 문서 검색

문서 제목, 설명, 태그를 통합 검색한다. MariaDB Full-Text Search 기반이다.

```
GET /api/search/documents?q=예산&page=0&size=20
```

| 파라미터 | 타입 | 필수 | 기본값 | 설명 |
|---------|------|------|-------|------|
| q | String | O | - | 검색 키워드 (최소 2자) |
| page | Integer | X | 0 | 페이지 번호 |
| size | Integer | X | 20 | 페이지 크기 |
| status | String | X | - | 태깅 상태 필터 |

#### Response (200 OK)

```json
{
  "success": true,
  "data": {
    "content": [
      {
        "documentId": "7c9e6679-...",
        "title": "2026년도 예산 집행 계획",
        "documentType": "pdf",
        "taggingStatus": "COMPLETED",
        "relevance": 12.5,
        "tags": ["예산", "계획서", "재정"],
        "createdAt": "2026-02-10T10:30:00Z"
      }
    ],
    "page": 0,
    "size": 20,
    "totalElements": 3,
    "totalPages": 1
  }
}
```

---

### 3.7 POST /api/jobs — Job 등록 (재태깅용)

기존 문서에 대해 OCR/태깅 Job을 새로 등록한다. 문서 업로드 시에는 Job이 자동 생성되므로, 이 API는 **재태깅**이 필요한 경우에 사용한다.

```
POST /api/jobs
Content-Type: application/json
```

```json
{
  "documentId": "7c9e6679-7425-40de-944b-e07fc1f90ae7"
}
```

| 파라미터 | 타입 | 필수 | 설명 |
|---------|------|------|------|
| documentId | String (UUID) | O | 재태깅할 문서 ID |

#### Response (201 Created)

```json
{
  "success": true,
  "data": {
    "jobId": "660e8400-e29b-41d4-a716-446655440001",
    "documentId": "7c9e6679-...",
    "status": "PENDING",
    "createdAt": "2026-02-10T11:00:00Z"
  }
}
```

---

### 3.8 GET /api/jobs/{jobId} — Job 상태 조회

OCR/태깅 Job의 처리 상태를 조회한다.

```
GET /api/jobs/550e8400-e29b-41d4-a716-446655440000
```

#### Response (200 OK)

```json
{
  "success": true,
  "data": {
    "jobId": "550e8400-...",
    "documentId": "7c9e6679-...",
    "status": "COMPLETED",
    "modelVersion": "kobert-v1.0",
    "startedAt": "2026-02-10T10:30:01Z",
    "completedAt": "2026-02-10T10:30:05Z",
    "createdAt": "2026-02-10T10:30:00Z"
  }
}
```

#### Job 상태값

| 상태 | 설명 |
|------|------|
| `PENDING` | 큐 대기 중 |
| `PROCESSING` | OCR/태깅 처리 중 |
| `COMPLETED` | 처리 완료 |
| `FAILED` | 처리 실패 (errorMessage 확인) |

---

### 3.9 POST /api/jobs/{jobId}/retry — Job 재실행

실패한 Job을 재실행한다.

```
POST /api/jobs/550e8400-e29b-41d4-a716-446655440000/retry
```

#### Response (200 OK)

```json
{
  "success": true,
  "data": {
    "jobId": "550e8400-...",
    "status": "PENDING",
    "message": "Job이 재실행 큐에 등록되었습니다"
  }
}
```

> **제약**: `FAILED` 상태의 Job만 재실행할 수 있다. 다른 상태에서 호출 시 `400 Bad Request`를 반환한다.

---

### 3.10 GET /api/users/me — 내 정보 조회

현재 인증된 사용자의 정보를 조회한다. 외부 SSO 헤더 기반으로 upsert된 사용자 레코드를 반환한다.

```
GET /api/users/me
```

#### Response (200 OK)

```json
{
  "success": true,
  "data": {
    "userId": "user-001",
    "name": "홍길동",
    "tenantId": "dept-a",
    "tenantName": "부서 A",
    "role": "dept-user",
    "firstSeenAt": "2026-02-01T09:00:00Z",
    "lastSeenAt": "2026-02-10T10:30:00Z"
  }
}
```

---

### 3.11 GET /api/health — 헬스 체크

App 서버 및 연동 시스템의 상태를 확인한다.

```
GET /api/health
```

#### Response (200 OK)

```json
{
  "status": "UP",
  "components": {
    "db-primary": { "status": "UP" },
    "db-replica": { "status": "UP" },
    "rabbit": { "status": "UP" },
    "s3": { "status": "UP" }
  }
}
```

> AI 서버 상태는 포함하지 않는다. AI 서버가 다운되어도 문서 업로드/조회는 정상 동작하므로, 헬스 체크 실패로 간주하지 않는다.

---

## 4. 공통 응답 형식

### 4.1 성공 응답

```json
{
  "success": true,
  "data": { ... }
}
```

### 4.2 에러 응답

```json
{
  "success": false,
  "error": {
    "code": "DOCUMENT_NOT_FOUND",
    "message": "문서를 찾을 수 없습니다",
    "requestId": "550e8400-e29b-41d4-a716-446655440000"
  }
}
```

### 4.3 페이지네이션 응답

```json
{
  "success": true,
  "data": {
    "content": [ ... ],
    "page": 0,
    "size": 20,
    "totalElements": 45,
    "totalPages": 3
  }
}
```

---

## 5. 에러 코드

### 5.1 HTTP 상태 코드

| HTTP 코드 | 사용 상황 |
|-----------|----------|
| 200 | 정상 조회/수정 |
| 201 | 리소스 생성 성공 |
| 400 | 잘못된 요청 (유효성 검증 실패) |
| 401 | 인증 실패 (헤더 누락) |
| 403 | 권한 없음 (RBAC 위반) |
| 404 | 리소스 없음 |
| 413 | 파일 크기 초과 (20MB) |
| 429 | 요청 빈도 초과 (Rate Limit) |
| 500 | 서버 내부 오류 |

### 5.2 비즈니스 에러 코드

| 에러 코드 | HTTP | 설명 |
|----------|------|------|
| `DOCUMENT_NOT_FOUND` | 404 | 문서를 찾을 수 없음 |
| `JOB_NOT_FOUND` | 404 | Job을 찾을 수 없음 |
| `JOB_NOT_RETRYABLE` | 400 | FAILED 상태가 아닌 Job 재실행 시도 |
| `TENANT_NOT_FOUND` | 404 | 테넌트를 찾을 수 없음 |
| `FILE_TOO_LARGE` | 413 | 파일 크기 20MB 초과 |
| `CONTENT_TOO_LONG` | 400 | 텍스트 입력 100,000자 초과 |
| `INVALID_FILE_TYPE` | 400 | 허용되지 않는 파일 형식 |
| `INVALID_FILE_NAME` | 400 | 유효하지 않은 파일명 (경로 순회 등) |
| `MISSING_AUTH_HEADER` | 401 | 인증 헤더 누락 |
| `INVALID_ROLE` | 403 | 유효하지 않은 역할 |
| `ACCESS_DENIED` | 403 | 접근 권한 없음 |
| `RATE_LIMIT_EXCEEDED` | 429 | 테넌트별 요청 빈도 초과 |
| `STORAGE_ERROR` | 500 | 스토리지(S3) 오류 |
| `INTERNAL_ERROR` | 500 | 서버 내부 오류 |

---

## 6. API 문서화 (Swagger)

### 6.1 SpringDoc OpenAPI 설정

```java
@Configuration
public class SwaggerConfig {

    @Bean
    public OpenAPI openAPI() {
        return new OpenAPI()
                .info(new Info()
                        .title("SmartDocs API")
                        .description("AI 기반 문서 태깅 시스템 API")
                        .version("1.0"))
                .addSecurityItem(new SecurityRequirement().addList("auth-headers"))
                .components(new Components()
                        .addSecuritySchemes("auth-headers",
                                new SecurityScheme()
                                        .type(SecurityScheme.Type.APIKEY)
                                        .in(SecurityScheme.In.HEADER)
                                        .name("X-User-ID")
                                        .description("인증 헤더 (X-User-ID, X-Department-ID, X-Role)")));
    }
}
```

### 6.2 API 문서 접근 경로

| 항목 | URL |
|------|-----|
| Swagger UI | `/swagger-ui.html` |
| OpenAPI JSON | `/v3/api-docs` |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 | 작성자 |
|------|------|----------|--------|
| 1.0 | 2026-02-09 | 초안 작성: 18개 엔드포인트, /v1/ 프리픽스 | - |
| 2.0 | 2026-02-10 | 전면 재작성: /api/ 프리픽스, 11개 MVP 엔드포인트, 텍스트+파일 업로드, Job 자동 생성, 20MB 파일 제한 | - |

---

## 관련 문서

- [07_백엔드_설계서.md](07_백엔드_설계서.md) - 백엔드 설계서 (상위 문서)
- [07-4_연동_설계서.md](07-4_연동_설계서.md) - 연동 설계서 (AI 서버 연동)
- [07-2_데이터베이스_설계서.md](07-2_데이터베이스_설계서.md) - 데이터베이스 설계서
- [07-3_보안_인증_설계서.md](07-3_보안_인증_설계서.md) - 보안/인증 설계서
